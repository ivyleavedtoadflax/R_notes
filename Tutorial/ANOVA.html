<html>

<head>
<style type="text/css">
.knitr.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
},
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0em 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage.left {
  text-align: left;
}
.rimage.right {
  text-align: right;
}
.rimage.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
<title>Getting Started with R - ANOVA</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css">

</head>

<body>

<table align="center" width="80%">
<tr>
<td class="next"><a href="regression.html">Previous</a></td>
<td class="next"><a href="index.html">Course Overview</a></td>
<td class="next"><a href="writing_functions.html">Next</a></td>
</tr>
</table>

<br><hr class="ex1"><br>

<h1>ANOVA</h1>

<h2>One-way ANOVA</h2>

<p>Analysis of variance is simple enough in R, using the <tt>aov()</tt> command. We will start with a simple One-Way ANOVA. We'll use data on the effect of two paint application methods (<tt>applic</tt>) and three primers (<tt>primer</tt>) on the quality of paint adherence (<tt>adhf</tt>).</p>

<p>You will need to download this data from <a href="goo.gl/qHwJAx">goo.gl/qHwJAx</a>, and import the data into <tt>R</tt> using one of the methods we have discussed previously. Call the dataframe <tt>paint</tt>.</p>

<div class="chunk" id="unnamed-chunk-1"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">paint</span>
</pre></div>
<div class="output"><pre class="knitr r">##    adhf primer  applic
## 1   4.0      1  Dipped
## 2   4.5      1  Dipped
## 3   4.3      1  Dipped
## 4   5.6      2  Dipped
## 5   4.9      2  Dipped
## 6   5.4      2  Dipped
## 7   3.8      3  Dipped
## 8   3.7      3  Dipped
## 9   4.0      3  Dipped
## 10  5.4      1 Sprayed
## 11  4.9      1 Sprayed
## 12  5.6      1 Sprayed
## 13  5.8      2 Sprayed
## 14  6.1      2 Sprayed
## 15  6.3      2 Sprayed
## 16  5.5      3 Sprayed
## 17  5.0      3 Sprayed
## 18  5.0      3 Sprayed
</pre></div>
</div></div>



<p>First we consider only the effect of <tt>primer</tt> - a one way ANOVA.</p>

<div class="chunk" id="unnamed-chunk-2"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">model</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">aov</span><span class="hl std">(</span>
     <span class="hl std">adhf</span> <span class="hl opt">~</span> <span class="hl std">primer,</span>
     <span class="hl kwc">data</span> <span class="hl std">= paint</span>
     <span class="hl std">)</span>
</pre></div>
</div></div>


<p>We need to call the results of this analysis with <tt>summary</tt>.</p>

<div class="chunk" id="unnamed-chunk-3"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">summary</span><span class="hl std">(model)</span>
</pre></div>
<div class="output"><pre class="knitr r">##             Df Sum Sq Mean Sq F value Pr(>F)
## primer       1   0.24   0.241    0.37   0.55
## Residuals   16  10.48   0.655
</pre></div>
</div></div>


<p>We get the usual ANOVA table that we would expect from this kind of analysis. Importantly, we see that the primer type does not appear to have a significant influence on the adherence of the paint (<code class="knitr inline">p=0.55</code>).</p>

<p><b>But wait!</b> We didn't specify that <tt>primer</tt> is meant to be a factor. Since it is numeric, R has no way of implicitly knowing this, so is currently treating <tt>primer</tt> as a continuous variable, which it definitely is not!</p>

<p>Let's re-run the analysis correctly identifying <tt>primer</tt> as a categorical variable.</p>

<div class="chunk" id="unnamed-chunk-4"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">paint</span><span class="hl opt">$</span><span class="hl std">primer</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">factor</span><span class="hl std">(paint</span><span class="hl opt">$</span><span class="hl std">primer)</span>
<span class="hl kwd">str</span><span class="hl std">(paint)</span>
</pre></div>
<div class="output"><pre class="knitr r">## 'data.frame':	18 obs. of  3 variables:
##  $ adhf  : num  4 4.5 4.3 5.6 4.9 5.4 3.8 3.7 4 5.4 ...
##  $ primer: Factor w/ 3 levels "1","2","3": 1 1 1 2 2 2 3 3 3 1 ...
##  $ applic: Factor w/ 2 levels "Dipped","Sprayed": 1 1 1 1 1 1 1 1 1 2 ...
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">model</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">aov</span><span class="hl std">(</span>
     <span class="hl std">adhf</span> <span class="hl opt">~</span> <span class="hl std">primer,</span>
     <span class="hl kwc">data</span> <span class="hl std">= paint</span>
     <span class="hl std">)</span>
<span class="hl kwd">summary</span><span class="hl std">(model)</span>
</pre></div>
<div class="output"><pre class="knitr r">##             Df Sum Sq Mean Sq F value Pr(>F)  
## primer       2   4.58   2.291     5.6  0.015 *
## Residuals   15   6.14   0.409                 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
</pre></div>
</div></div>


<p>This time, we see that primer type does have a significant effect. Let's plot the data:</p>


<div class="chunk" id="ANOVA1"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">boxplot</span><span class="hl std">(</span>
     <span class="hl kwd">split</span><span class="hl std">(</span>
          <span class="hl std">paint</span><span class="hl opt">$</span><span class="hl std">adhf,</span>
          <span class="hl std">paint</span><span class="hl opt">$</span><span class="hl std">primer</span>
          <span class="hl std">)</span>
     <span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/ANOVA1.png" title="plot of chunk ANOVA1" alt="plot of chunk ANOVA1" class="plot" /></div></div>


<p>So it looks like primer 2 is the most effective, but we still don't know if there are significant differences between primer 1 and 2, and 1 and 3, although we can guess there is a significant difference between 1 and 3.</p>

<p>We can use <tt>model.tables()</tt> to get a list of the effects:</p>

<div class="chunk" id="unnamed-chunk-5"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">model.tables</span><span class="hl std">(</span>
     <span class="hl kwc">x</span> <span class="hl std">= model,</span>
     <span class="hl kwc">type</span><span class="hl std">=</span><span class="hl str">&quot;mean&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">se</span> <span class="hl std">=</span> <span class="hl num">TRUE</span>
     <span class="hl std">)</span>
</pre></div>
<div class="output"><pre class="knitr r">## Tables of means
## Grand mean
##       
## 4.989 
## 
##  primer 
## primer
##     1     2     3 
## 4.783 5.683 4.500 
## 
## Standard errors for differences of means
##         primer
##         0.3693
## replic.      6
</pre></div>
</div></div>


<p>This gives us the treatment means, and the standard error of the differences. Note that a more versatile way of calculating data for groups is the <tt>melt</tt> and <tt>cast</tt> methods that we have used earlier.</p>

<div class="ex">

<h3>Exercise</h3>

<p>Get the median, mean, standard deviation, standard error, upper and lower 95% confidence intervals for the three primers in the <tt>paint</tt> data</p>








</div>

<h3>Multiple comparisons</h3>

<p>If we really want to know whether there are significant differences between the means, we need to do some sort of multiple comparison test. Be aware that there are dozens of possible multiple comparison tests, and there is some controversy about their use. In particular, you should be aware of controlling the family-wise error rate, which can be inflated in uncontrolled 'least significant difference' (LSD) tests. See <a href="http://en.wikipedia.org/wiki/Multiple_comparisons">http://en.wikipedia.org/wiki/Multiple_comparisons</a> and <a href="http://en.wikipedia.org/wiki/Familywise_error_rate">http://en.wikipedia.org/wiki/Familywise_error_rate</a> for more information. There is also a discussion of the problem on p.482 of the R book.</p>

<p>There are built in functions to do this analysis, but we will use the package <tt>agricolae</tt> which has greater functionality.</p>

<p>For this example we will use Tukey's Honest Significant Difference test (HSD), which provides a reasonably conservative test.</p>

<div class="chunk" id="unnamed-chunk-8"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">require</span><span class="hl std">(agricolae)</span>
<span class="hl com"># Note that here we have to specify the response (y) and the treatment (trt) of</span>
<span class="hl com"># interest, in adittion to the mean residual mean squares and residual degree of</span>
<span class="hl com"># freedom. These are taken from the summary(model) table.</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl std">HSD_primer</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">HSD.test</span><span class="hl std">(</span>
     <span class="hl kwc">y</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">adhf,</span>
     <span class="hl kwc">trt</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">primer,</span>
     <span class="hl kwc">MSerror</span> <span class="hl std">=</span> <span class="hl num">0.4091</span><span class="hl std">,</span>
     <span class="hl kwc">DFerror</span> <span class="hl std">=</span> <span class="hl num">15</span><span class="hl std">,</span>
     <span class="hl kwc">alpha</span> <span class="hl std">=</span> <span class="hl num">0.05</span>
     <span class="hl std">)</span>
<span class="hl com"># Note that it is possible to automate the extraction of these values from the</span>
<span class="hl com"># model object. And this is worth doing if you are running a lot of multiple</span>
<span class="hl com"># comparison tests.</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com"># Here is some code I have written to do just that. The if statements deal with</span>
<span class="hl com"># the cases in which you have a nested experimental structure.</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl std">ms_w</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">) {</span>
     <span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl str">&quot;Within&quot;</span> <span class="hl opt">%in%</span> <span class="hl kwd">names</span><span class="hl std">(x)) {</span>
          <span class="hl std">y</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">summary</span><span class="hl std">(x</span><span class="hl opt">$</span><span class="hl std">Within)[[</span><span class="hl num">1</span><span class="hl std">]][[</span><span class="hl num">3</span><span class="hl std">]]</span>
          <span class="hl kwd">tail</span><span class="hl std">(y,</span><span class="hl num">1</span><span class="hl std">)</span>
          <span class="hl std">}</span>    <span class="hl kwa">else</span>  <span class="hl std">{</span>
               <span class="hl std">y</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">summary</span><span class="hl std">(x)[[</span><span class="hl num">1</span><span class="hl std">]][[</span><span class="hl num">3</span><span class="hl std">]]</span>
               <span class="hl kwd">tail</span><span class="hl std">(y,</span><span class="hl num">1</span><span class="hl std">)</span>
               <span class="hl std">}</span>
     <span class="hl std">}</span>
<span class="hl std">df_w</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">) {</span>
     <span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl str">&quot;Within&quot;</span> <span class="hl opt">%in%</span> <span class="hl kwd">names</span><span class="hl std">(x)) {</span>
          <span class="hl std">x</span><span class="hl opt">$</span><span class="hl std">Within</span><span class="hl opt">$</span><span class="hl std">df.residual</span>
          <span class="hl std">}</span>    <span class="hl kwa">else</span>  <span class="hl std">{</span>
               <span class="hl std">x</span><span class="hl opt">$</span><span class="hl std">df.residual</span>
               <span class="hl std">}</span>
     <span class="hl std">}</span>
<span class="hl com">#</span>
<span class="hl com"># Check these against the output from the model:</span>
<span class="hl com">#</span>
<span class="hl kwd">ms_w</span><span class="hl std">(model)</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 0.4091
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">df_w</span><span class="hl std">(model)</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 15
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">#</span>
<span class="hl com"># And the test again with the automated functions</span>
<span class="hl com">#</span>
<span class="hl std">HSD_primer</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">HSD.test</span><span class="hl std">(</span>
     <span class="hl kwc">y</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">adhf,</span>
     <span class="hl kwc">trt</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">primer,</span>
     <span class="hl kwc">MSerror</span> <span class="hl std">=</span> <span class="hl kwd">ms_w</span><span class="hl std">(model),</span>
     <span class="hl kwc">DFerror</span> <span class="hl std">=</span> <span class="hl kwd">df_w</span><span class="hl std">(model),</span>
     <span class="hl kwc">alpha</span> <span class="hl std">=</span> <span class="hl num">0.05</span>
     <span class="hl std">)</span>
<span class="hl std">HSD_primer</span>
</pre></div>
<div class="output"><pre class="knitr r">## $statistics
##    Mean    CV MSerror    HSD
##   4.989 12.82  0.4091 0.9592
## 
## $parameters
##   Df ntr StudentizedRange
##   15   3            3.673
## 
## $means
##   paint$adhf    std r Min Max
## 1      4.783 0.6306 6 4.0 5.6
## 2      5.683 0.5037 6 4.9 6.3
## 3      4.500 0.7589 6 3.7 5.5
## 
## $comparison
## NULL
## 
## $groups
##   trt means  M
## 1   2 5.683  a
## 2   1 4.783 ab
## 3   3 4.500  b
</pre></div>
</div></div>


<p>Amongst all the output we get, is a table of groups:</p>

<div class="chunk" id="unnamed-chunk-9"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">HSD_primer</span><span class="hl opt">$</span><span class="hl std">groups</span>
</pre></div>
<div class="output"><pre class="knitr r">##   trt means  M
## 1   2 5.683  a
## 2   1 4.783 ab
## 3   3 4.500  b
</pre></div>
</div></div>


<p>Here, means with the same letter indicate no significant difference. Hence we see that primer 2 is significantly different from primer 3, but there is no difference between primer 1 and 2, or primer 2 and 3. Note that we used <tt>alpha = 0.05</tt>, but you can use a more stringent <tt>alpha</tt> if necessary.</p>

<p>We can display these differences using error bars and letters to signify significant differences in the plot below. The function <tt>se_lines()</tt> can quite easily be adapted to your own plots.</p>

<div class="chunk" id="ANOVA2"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">require</span><span class="hl std">(reshape)</span>
<span class="hl std">paint_m</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">melt</span><span class="hl std">(</span>
     <span class="hl std">paint,</span>
     <span class="hl kwc">id</span> <span class="hl std">=</span> <span class="hl num">2</span><span class="hl opt">:</span><span class="hl num">3</span>
     <span class="hl std">)</span>
<span class="hl std">paint_c</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">cast</span><span class="hl std">(</span>
     <span class="hl std">paint_m,</span>
     <span class="hl std">primer</span> <span class="hl opt">~</span> <span class="hl std">variable,</span>
     <span class="hl kwd">c</span><span class="hl std">(mean,se,lci95,uci95)</span>
     <span class="hl std">)</span>
<span class="hl std">paint_plot</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">barplot</span><span class="hl std">(</span>
     <span class="hl std">paint_c</span><span class="hl opt">$</span><span class="hl std">adhf_mean,</span>
     <span class="hl kwc">ylab</span> <span class="hl std">=</span> <span class="hl str">&quot;Adhesion factor&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">xlab</span> <span class="hl std">=</span> <span class="hl str">&quot;Primer&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">ylim</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span><span class="hl num">7</span><span class="hl std">),</span>
     <span class="hl kwc">space</span> <span class="hl std">=</span> <span class="hl num">0.1</span><span class="hl std">,</span>
     <span class="hl kwc">names</span> <span class="hl std">= paint_c</span><span class="hl opt">$</span><span class="hl std">primer</span>
     <span class="hl std">)</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com"># Specify function to take four arguments: </span>
<span class="hl com">#</span>
<span class="hl com"># x is the dataframe from which the  summary data comes, in our case, a cast</span>
<span class="hl com"># object. This object must contain a mean and se column</span>
<span class="hl com">#</span>
<span class="hl com"># y is the name of the plot - we  need to give the plot an object name due to</span>
<span class="hl com"># vagaries of the barplot function - by naming it as an object, we can place</span>
<span class="hl com"># labels and error bars more precisely.</span>
<span class="hl com">#</span>
<span class="hl com"># Hline is the length of horizontal lines used in error bars. It is also used to</span>
<span class="hl com"># specify the position of the significance letter. MCT is the name of the</span>
<span class="hl com">#</span>
<span class="hl com"># Multiple comparison test object output from agricolae - this will be an</span>
<span class="hl com"># HSD.test or LSD.test object.</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl std">se_lines</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">,</span><span class="hl kwc">y</span><span class="hl std">,</span><span class="hl kwc">Hline</span><span class="hl std">,</span><span class="hl kwc">MCT</span><span class="hl std">) {</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com"># Run a loop for the same number of times as we have levels of treatment</span>
<span class="hl com"># factors</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl kwa">for</span> <span class="hl std">(i</span> <span class="hl kwa">in</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl kwd">length</span><span class="hl std">(x[,</span><span class="hl num">1</span><span class="hl std">])) {</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com"># Find the mean and se columns using grep</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
     <span class="hl std">x_mean</span> <span class="hl kwb">&lt;-</span> <span class="hl std">x[,</span><span class="hl kwd">grep</span><span class="hl std">(</span><span class="hl str">&quot;mean&quot;</span><span class="hl std">,</span><span class="hl kwd">names</span><span class="hl std">(x))]</span>
     <span class="hl std">x_se</span> <span class="hl kwb">&lt;-</span> <span class="hl std">x[,</span><span class="hl kwd">grep</span><span class="hl std">(</span><span class="hl str">&quot;se&quot;</span><span class="hl std">,</span><span class="hl kwd">names</span><span class="hl std">(x))]</span>
<span class="hl com">#</span>
<span class="hl com">#     </span>
<span class="hl com"># Create error bars</span>
<span class="hl com">#</span>
<span class="hl com">#     </span>
  <span class="hl kwd">lines</span><span class="hl std">(</span>
    <span class="hl kwd">c</span><span class="hl std">(y[i],y[i]),</span>
    <span class="hl kwd">c</span><span class="hl std">(x_mean[i]</span><span class="hl opt">+</span><span class="hl std">(x_se[i]),x_mean[i]</span><span class="hl opt">-</span><span class="hl std">(x_se[i]))</span>
  <span class="hl std">)</span>
  <span class="hl kwd">lines</span><span class="hl std">(</span>
    <span class="hl kwd">c</span><span class="hl std">(y[i]</span><span class="hl opt">-</span><span class="hl std">Hline,y[i]</span><span class="hl opt">+</span><span class="hl std">Hline),</span>
    <span class="hl kwd">c</span><span class="hl std">(x_mean[i]</span><span class="hl opt">+</span><span class="hl std">(x_se[i]),x_mean[i]</span><span class="hl opt">+</span><span class="hl std">(x_se[i]))</span>
  <span class="hl std">)</span>
  <span class="hl kwd">lines</span><span class="hl std">(</span>
    <span class="hl kwd">c</span><span class="hl std">(y[i]</span><span class="hl opt">-</span><span class="hl std">Hline,y[i]</span><span class="hl opt">+</span><span class="hl std">Hline),</span>
    <span class="hl kwd">c</span><span class="hl std">(x_mean[i]</span><span class="hl opt">-</span><span class="hl std">(x_se[i]),x_mean[i]</span><span class="hl opt">-</span><span class="hl std">(x_se[i]))</span>
    <span class="hl std">)</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com"># Add significance letters above the error bars.</span>
<span class="hl com">#    </span>
<span class="hl com"># Get the correct order for the significance labels from the agricolae test</span>
<span class="hl com"># object. This step is required, because the output from agricolae test</span>
<span class="hl com"># objects are ordered by effect size, not by the initial order of factors</span>
<span class="hl com"># specified in the input dataframe.</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
     <span class="hl std">sig_labels</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">sapply</span><span class="hl std">(x[,</span><span class="hl num">1</span><span class="hl std">],</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">z</span><span class="hl std">) {</span>
          <span class="hl std">MCT</span><span class="hl opt">$</span><span class="hl std">groups</span><span class="hl opt">$</span><span class="hl std">M[</span><span class="hl kwd">grep</span><span class="hl std">(z,MCT</span><span class="hl opt">$</span><span class="hl std">groups</span><span class="hl opt">$</span><span class="hl std">trt)]</span>
          <span class="hl std">}</span>
          <span class="hl std">)</span>
  <span class="hl kwd">text</span><span class="hl std">(</span>
       <span class="hl kwc">y</span> <span class="hl std">= x_mean[i]</span> <span class="hl opt">+</span> <span class="hl std">x_se[i]</span> <span class="hl opt">+</span> <span class="hl num">5</span> <span class="hl opt">*</span> <span class="hl std">Hline,</span>
       <span class="hl kwc">x</span> <span class="hl std">= y[i],</span>
       <span class="hl kwc">labels</span> <span class="hl std">= sig_labels[i],</span>
       <span class="hl kwc">cex</span> <span class="hl std">=</span> <span class="hl num">1</span>
  <span class="hl std">)</span>
  <span class="hl std">}</span>
<span class="hl std">}</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl com"># Run the final code:</span>
<span class="hl com">#</span>
<span class="hl com">#</span>
<span class="hl kwd">se_lines</span><span class="hl std">(</span>
     <span class="hl std">paint_c,</span>
     <span class="hl std">paint_plot,</span>
     <span class="hl num">0.1</span><span class="hl std">,</span>
     <span class="hl std">HSD_primer</span>
     <span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/ANOVA2.png" title="plot of chunk ANOVA2" alt="plot of chunk ANOVA2" class="plot" /></div></div>


<h2>Two-way ANOVA</h2>

<p>OK so now we will include the effect of application method into our model, creating a Two-way ANOVA.</p>

<div class="chunk" id="unnamed-chunk-10"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">model1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">aov</span><span class="hl std">(</span>
     <span class="hl kwc">formula</span> <span class="hl std">= adhf</span> <span class="hl opt">~</span> <span class="hl std">primer</span> <span class="hl opt">*</span> <span class="hl std">applic,</span>
     <span class="hl kwc">data</span> <span class="hl std">= paint</span>
     <span class="hl std">)</span>
</pre></div>
</div></div>


<p>Note that we used the formula <tt>adhf ~ primer * applic</tt> in order to look at all the interactions between the two factors. If we didn't want to look at the interactions we would use <tt>+</tt> instead of <tt>*</tt> - but you need to have a good reason to do this.</p>

<div class="chunk" id="unnamed-chunk-11"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">summary</span><span class="hl std">(model1)</span>
</pre></div>
<div class="output"><pre class="knitr r">##               Df Sum Sq Mean Sq F value  Pr(>F)    
## primer         2   4.58    2.29   27.86 3.1e-05 ***
## applic         1   4.91    4.91   59.70 5.4e-06 ***
## primer:applic  2   0.24    0.12    1.47    0.27    
## Residuals     12   0.99    0.08                    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
</pre></div>
</div></div>


<p>So it looks like the <tt>primer</tt> and <tt>applic</tt> factors both have a significant effect on <tt>adhf</tt>, but there is no significant interaction between the two. If you follow the model-simplification method, you might now want to remove this unimportant interaction, leaving you with just the significant interactions:</p>

<div class="chunk" id="unnamed-chunk-12"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">model2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">update</span><span class="hl std">(model1,</span><span class="hl opt">~</span><span class="hl std">.</span><span class="hl opt">-</span><span class="hl std">primer</span><span class="hl opt">:</span><span class="hl std">applic)</span>
<span class="hl kwd">summary</span><span class="hl std">(model2)</span>
</pre></div>
<div class="output"><pre class="knitr r">##             Df Sum Sq Mean Sq F value  Pr(>F)    
## primer       2   4.58    2.29    26.1 1.9e-05 ***
## applic       1   4.91    4.91    56.0 3.0e-06 ***
## Residuals   14   1.23    0.09                    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
</pre></div>
</div></div>


<p>More on this can be found in Crawley. But for now, we will not remove the non-significant terms.</p>

<p>We must of course check for the assumptions of a linear model with ANOVA, as with regression. For brevity, we did not do this in the previous example - but you would need to in your analysis.</p>

<div class="chunk" id="ANOVA3"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">par</span><span class="hl std">(</span><span class="hl kwc">mfrow</span><span class="hl std">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">4</span><span class="hl std">,</span><span class="hl num">1</span><span class="hl std">))</span>
<span class="hl kwd">plot</span><span class="hl std">(model1)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/ANOVA3.png" title="plot of chunk ANOVA3" alt="plot of chunk ANOVA3" class="plot" /></div><div class="rcode">
<div class="source"><pre class="knitr r"><span class="hl kwd">par</span><span class="hl std">(</span><span class="hl kwc">mfrow</span><span class="hl std">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">,</span><span class="hl num">1</span><span class="hl std">))</span>
</pre></div>
</div></div>


<p>Additional diagnostic plots can be produced with:</p>

<div class="chunk" id="ANOVA4"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">par</span><span class="hl std">(</span><span class="hl kwc">mfrow</span><span class="hl std">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">4</span><span class="hl std">,</span><span class="hl num">1</span><span class="hl std">))</span>
<span class="hl kwd">qqnorm</span><span class="hl std">(</span><span class="hl kwd">resid</span><span class="hl std">(model1))</span>
<span class="hl kwd">qqline</span><span class="hl std">(</span><span class="hl kwd">resid</span><span class="hl std">(model1))</span>
<span class="hl kwd">hist</span><span class="hl std">(</span><span class="hl kwd">resid</span><span class="hl std">(model1))</span>
<span class="hl kwd">plot</span><span class="hl std">(</span><span class="hl kwd">density</span><span class="hl std">(</span><span class="hl kwd">resid</span><span class="hl std">(model1)))</span>
<span class="hl kwd">plot</span><span class="hl std">(</span><span class="hl kwd">fitted</span><span class="hl std">(model1),</span><span class="hl kwd">resid</span><span class="hl std">(model1))</span>
</pre></div>
</div><div class="rimage default"><img src="figure/ANOVA4.png" title="plot of chunk ANOVA4" alt="plot of chunk ANOVA4" class="plot" /></div><div class="rcode">
<div class="source"><pre class="knitr r"><span class="hl kwd">par</span><span class="hl std">(</span><span class="hl kwc">mfrow</span><span class="hl std">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">,</span><span class="hl num">1</span><span class="hl std">))</span>
</pre></div>
</div></div>


<p>I think we can just about get away with that, although there is some suggestion of non-normality in the QQ plot. Transformation may improve that...</p>

<p>Now the multiple comparison test. Again we will use Tukey's HSD test. We found no interactions between primer and application method. Note that we must re-run our test of primer, because the model has changed, and with it the residual mean squares and the degrees of freedom.</p>

<div class="chunk" id="unnamed-chunk-13"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">HSD_primer</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">HSD.test</span><span class="hl std">(</span>
     <span class="hl kwc">y</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">adhf,</span>
     <span class="hl kwc">trt</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">primer,</span>
     <span class="hl kwc">MSerror</span> <span class="hl std">=</span> <span class="hl kwd">ms_w</span><span class="hl std">(model1),</span>
     <span class="hl kwc">DFerror</span> <span class="hl std">=</span> <span class="hl kwd">df_w</span><span class="hl std">(model1),</span>
     <span class="hl kwc">alpha</span> <span class="hl std">=</span> <span class="hl num">0.05</span>
     <span class="hl std">)</span>
<span class="hl std">HSD_primer</span>
</pre></div>
<div class="output"><pre class="knitr r">## $statistics
##    Mean    CV MSerror    HSD
##   4.989 5.748 0.08222 0.4417
## 
## $parameters
##   Df ntr StudentizedRange
##   12   3            3.773
## 
## $means
##   paint$adhf    std r Min Max
## 1      4.783 0.6306 6 4.0 5.6
## 2      5.683 0.5037 6 4.9 6.3
## 3      4.500 0.7589 6 3.7 5.5
## 
## $comparison
## NULL
## 
## $groups
##   trt means M
## 1   2 5.683 a
## 2   1 4.783 b
## 3   3 4.500 b
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">HSD_applic</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">HSD.test</span><span class="hl std">(</span>
     <span class="hl kwc">y</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">adhf,</span>
     <span class="hl kwc">trt</span> <span class="hl std">= paint</span><span class="hl opt">$</span><span class="hl std">applic,</span>
     <span class="hl kwc">MSerror</span> <span class="hl std">=</span> <span class="hl kwd">ms_w</span><span class="hl std">(model1),</span>
     <span class="hl kwc">DFerror</span> <span class="hl std">=</span> <span class="hl kwd">df_w</span><span class="hl std">(model1),</span>
     <span class="hl kwc">alpha</span> <span class="hl std">=</span> <span class="hl num">0.05</span>
     <span class="hl std">)</span>
<span class="hl std">HSD_applic</span>
</pre></div>
<div class="output"><pre class="knitr r">## $statistics
##    Mean    CV MSerror    HSD
##   4.989 5.748 0.08222 0.2945
## 
## $parameters
##   Df ntr StudentizedRange
##   12   2            3.081
## 
## $means
##         paint$adhf    std r Min Max
## Dipped       4.467 0.6928 9 3.7 5.6
## Sprayed      5.511 0.4961 9 4.9 6.3
## 
## $comparison
## NULL
## 
## $groups
##       trt means M
## 1 Sprayed 5.511 a
## 2 Dipped  4.467 b
</pre></div>
</div></div>


<p>So we find that things change for primer under the new model, and there are significant differences between primer 2 and primers 1 and 3:</p>

<div class="chunk" id="unnamed-chunk-14"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">HSD_primer</span><span class="hl opt">$</span><span class="hl std">groups</span>
</pre></div>
<div class="output"><pre class="knitr r">##   trt means M
## 1   2 5.683 a
## 2   1 4.783 b
## 3   3 4.500 b
</pre></div>
</div></div>


<p>For application method, we see that spray application is more effective than dipping.</p>

<div class="chunk" id="unnamed-chunk-15"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">HSD_applic</span><span class="hl opt">$</span><span class="hl std">groups</span>
</pre></div>
<div class="output"><pre class="knitr r">##       trt means M
## 1 Sprayed 5.511 a
## 2 Dipped  4.467 b
</pre></div>
</div></div>


<p>Let's plot these together</p>

<div class="chunk" id="ANOVA5"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">par</span><span class="hl std">(</span><span class="hl kwc">mfrow</span><span class="hl std">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">2</span><span class="hl std">,</span><span class="hl num">1</span><span class="hl std">))</span>
<span class="hl std">paint_plot</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">barplot</span><span class="hl std">(</span>
     <span class="hl std">paint_c</span><span class="hl opt">$</span><span class="hl std">adhf_mean,</span>
     <span class="hl kwc">ylab</span> <span class="hl std">=</span> <span class="hl str">&quot;Adhesion factor&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">xlab</span> <span class="hl std">=</span> <span class="hl str">&quot;Primer&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">ylim</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span><span class="hl num">7</span><span class="hl std">),</span>
     <span class="hl kwc">space</span> <span class="hl std">=</span> <span class="hl num">0.1</span><span class="hl std">,</span>
     <span class="hl kwc">names</span> <span class="hl std">= paint_c</span><span class="hl opt">$</span><span class="hl std">primer</span>
     <span class="hl std">)</span>
<span class="hl kwd">se_lines</span><span class="hl std">(</span>
     <span class="hl std">paint_c,</span>
     <span class="hl std">paint_plot,</span>
     <span class="hl num">0.1</span><span class="hl std">,</span>
     <span class="hl std">HSD_primer</span>
     <span class="hl std">)</span>
<span class="hl std">paint_c2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">cast</span><span class="hl std">(</span>
     <span class="hl std">paint_m,</span>
     <span class="hl std">applic</span> <span class="hl opt">~</span> <span class="hl std">variable,</span>
     <span class="hl kwd">c</span><span class="hl std">(mean,se)</span>
     <span class="hl std">)</span>
<span class="hl std">paint_plot</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">barplot</span><span class="hl std">(</span>
     <span class="hl std">paint_c2</span><span class="hl opt">$</span><span class="hl std">adhf_mean,</span>
     <span class="hl kwc">ylab</span> <span class="hl std">=</span> <span class="hl str">&quot;Adhesion factor&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">xlab</span> <span class="hl std">=</span> <span class="hl str">&quot;Application method&quot;</span><span class="hl std">,</span>
     <span class="hl kwc">ylim</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span><span class="hl num">7</span><span class="hl std">),</span>
     <span class="hl kwc">space</span> <span class="hl std">=</span> <span class="hl num">0.1</span><span class="hl std">,</span>
     <span class="hl kwc">names</span> <span class="hl std">= paint_c2</span><span class="hl opt">$</span><span class="hl std">applic</span>
     <span class="hl std">)</span>
<span class="hl kwd">se_lines</span><span class="hl std">(</span>
     <span class="hl std">paint_c2,</span>
     <span class="hl std">paint_plot,</span>
     <span class="hl num">0.1</span><span class="hl std">,</span>
     <span class="hl std">HSD_applic</span>
     <span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/ANOVA5.png" title="plot of chunk ANOVA5" alt="plot of chunk ANOVA5" class="plot" /></div><div class="rcode">
<div class="source"><pre class="knitr r"><span class="hl kwd">par</span><span class="hl std">(</span><span class="hl kwc">mfrow</span><span class="hl std">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">,</span><span class="hl num">1</span><span class="hl std">))</span>
</pre></div>
</div></div>




<br><hr class="ex1"><br>

<table align="center" width="80%">
<tr>
<td class="next"><a href="regression.html">Previous</a></td>
<td class="next"><a href="index.html">Course Overview</a></td>
<td class="next"><a href="writing_functions.html">Next</a></td>
</tr>
</table>

</body>

</html>
